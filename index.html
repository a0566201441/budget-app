
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حاسبة الراتب والمصاريف (v6 - singlefile)</title>
  <!-- Inline CSS (UI polish) -->
  <style>
  :root{
    --bg:#0b0f14; --surface:#121822; --surface-2:#0f141c; --border:#1e2a3a;
    --text:#e9eef5; --muted:#9fb1cc; --pill-bg:#132032; --pill-text:#9cc2ff;
    --primary:#1e90ff; --danger:#ef4444; --ok:#22c55e; --warn:#facc15;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:"Segoe UI",Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px;line-height:1.55;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  :where(button,input,select,textarea):focus-visible{outline:2px solid var(--pill-text);outline-offset:2px;box-shadow:0 0 0 3px rgba(156,194,255,0.15);}
  h1{margin-bottom:16px;font-size:1.5rem;color:#fff}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 6px 14px rgba(0,0,0,.35);transition:transform .12s ease, box-shadow .12s ease;}
  .card:hover{ transform:translateY(-1px); box-shadow:0 10px 20px rgba(0,0,0,.4); }
  label{display:block;margin-top:10px;margin-bottom:6px;font-size:.95rem;color:#cbd5e1}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);}
  textarea{min-height:96px;resize:vertical}
  button{padding:10px 14px;border-radius:12px;border:none;cursor:pointer;transition:transform .12s ease, opacity .2s;font-weight:600;}
  button:hover{ opacity:.95; transform:translateY(-1px); } button:active{ transform:translateY(0); }
  .danger{background:var(--danger);color:#fff} .primary{background:var(--primary);color:#fff} .ghost{background:transparent;border:1px solid var(--border);color:#cbd5e1}
  .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:var(--pill-bg);color:var(--pill-text);font-size:.85rem}
  .totals{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
  .totals div{background:var(--surface-2);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center} .row>div{margin-left:15px;margin-right:15px}
  .muted{color:var(--muted);font-size:.95rem}
  table.main-table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:10px;display:block;overflow-x:auto;white-space:nowrap}
  th,td{text-align:center;padding:12px} .main-table th,.main-table td{min-width:120px}
  thead th{background:#1a2230;color:#cbd5e1;font-weight:600;position:sticky;top:0;z-index:1}
  tbody tr{background:var(--surface-2);border:1px solid var(--border)} tbody td{border-top:1px solid var(--border)}
  .col-planned,td.col-planned{min-width:130px} .col-paid,td.col-paid{min-width:130px} .col-due,td.col-due{min-width:140px}
  .main-table td input[type='number']{width:120px;text-align:end} .main-table td input[type='text']{width:160px}
  tbody tr:hover{outline:1px solid rgba(156,194,255,0.25)}
  .status{font-weight:700} .status.مدفوع{color:var(--ok)} .status.مدفوع-جزئي{color:var(--warn)} .status.غير-مدفوع{color:var(--primary)} .status.دخل{color:#60a5fa}
  .mark{display:inline-block;margin-inline-start:8px;padding:2px 8px;border-radius:999px;font-size:.8rem;border:1px solid var(--border);background:var(--surface-2);color:var(--pill-text)}
  .sub-table{margin-top:8px;border:1px solid var(--border);border-radius:10px;width:100%} .sub-table th{background:#1a2230;color:var(--pill-text)} .sub-table td{background:#141c26}
  #history-chart-wrap{height:260px;position:relative;margin-top:16px} #delta-chart-wrap{height:240px;position:relative;margin-top:16px} #history-chart,#delta-chart{width:100%!important;height:100%!important;display:block}

  @media (max-width:430px){
    html,body{margin:0;padding:0;width:100%;max-width:100vw;overflow-x:hidden;}
    #rows{width:100%;max-width:100vw;table-layout:auto;border-collapse:separate;border-spacing:0;direction:rtl;}
    #rows tr{display:grid;width:90vw;max-width:90vw;margin:10px auto;box-sizing:border-box;grid-template-areas:"name planned" "paid due" "status actions" "detailsInput detailsToggle" "detailsPanel detailsPanel";grid-template-columns:1fr 1fr;column-gap:10px;row-gap:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:10px 12px;align-items:start;overflow:hidden;}
    #rows thead,#rows th{display:none!important}
    #rows td:nth-child(1){grid-area:name} #rows td:nth-child(2){grid-area:planned} #rows td:nth-child(3){grid-area:paid} #rows td:nth-child(4){grid-area:due} #rows td:nth-child(5){grid-area:status} #rows td:nth-child(6){grid-area:actions}
    #rows td{position:relative;padding:6px 4px;box-sizing:border-box}
    #rows td::before{display:block;font-size:.95rem;font-weight:700;opacity:.95;margin-bottom:6px;line-height:1.15;color:#fff;text-align:center}
    #rows td:nth-child(1)::before{content:"المصروف"} #rows td:nth-child(2)::before{content:"المخطط"} #rows td:nth-child(3)::before{content:"المدفوع"} #rows td:nth-child(4)::before{content:"المتبقي"} #rows td:nth-child(5)::before{content:"الحالة"} #rows td:nth-child(6)::before{content:"الإجراءات"}
    #rows input,#rows select,#rows textarea{width:100%;max-width:100%;padding:8px 10px;min-width:0;box-sizing:border-box}
    #rows td:nth-child(1),#rows td:nth-child(2),#rows td:nth-child(3),#rows td:nth-child(4){display:flex;flex-direction:column;align-items:center;text-align:center}
    #rows td:nth-child(1) input{width:16ch;max-width:90%;margin:0 auto}
    #rows td:nth-child(2) input,#rows td:nth-child(3) input,#rows td:nth-child(4) input{width:8ch;max-width:8ch;text-align:end;margin:0 auto}
    #rows td:nth-child(6){display:flex;flex-direction:column;align-items:center;gap:8px;text-align:center}
    #rows td.mobile-details-input::before{content:"إضافة تفاصيل";text-align:center;width:100%}
    #rows td.mobile-details-toggle::before{content:"التفاصيل";text-align:center;width:100%}
    #rows td.mobile-details-panel{grid-area:detailsPanel;border:1px dashed rgba(255,255,255,0.15);border-radius:10px;padding:10px;display:none;width:100%;box-sizing:border-box}
    #rows td.mobile-details-panel .placeholder{opacity:.8;font-size:.95rem;text-align:center;padding:4px 0}
    #rows td.mobile-details-panel .details-list{display:flex;flex-direction:column;gap:8px}
    #rows td.mobile-details-panel .detail-item{display:grid;grid-template-columns:1fr 9ch 34px;gap:8px;align-items:center}
    #rows td.mobile-details-panel .detail-item input[type="text"]{width:100%}
    #rows td.mobile-details-panel .detail-item input[data-role="value"]{width:9ch;max-width:9ch;text-align:end;direction:ltr}
    #rows td.mobile-details-panel .detail-item button.del{background:#c0392b;color:#fff;border:none;border-radius:8px;width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1rem}
    #rows td .mobile-status-text{margin-top:2px;font-size:.9rem;text-align:center;font-weight:600}
  }
  </style>
</head>
<body>
  <h1>💰 حاسبة الراتب والمصاريف</h1>

  <div class="card">
    <div class="row">
      <div style="flex:1 1 200px">
        <label>السنة</label>
        <input id="year-input" type="number" />
      </div>
      <div style="flex:1 1 220px">
        <label>الشهر (ميلادي)</label>
        <select id="month-select">
          <option value="01">يناير</option><option value="02">فبراير</option><option value="03">مارس</option>
          <option value="04">أبريل</option><option value="05">مايو</option><option value="06">يونيو</option>
          <option value="07">يوليو</option><option value="08">أغسطس</option><option value="09">سبتمبر</option>
          <option value="10">أكتوبر</option><option value="11">نوفمبر</option><option value="12">ديسمبر</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="save-template" class="primary">💾 حفظ كقالب</button>
      <div style="flex:1 1 260px">
        <label>القوالب</label>
        <div class="row">
          <select id="templates-select" style="flex:1 1 220px"></select>
          <button id="apply-template" class="ghost">تطبيق</button>
          <button id="delete-template" class="danger">حذف القالب</button>
        </div>
      </div>
      <button id="close-month" class="primary">📦 إغلاق الشهر وحفظه</button>
      <button id="reset" class="danger">تفريغ الكل</button>
      <button id="export-history" class="ghost">تصدير الأرشيف JSON</button>
      <button id="export-csv" class="ghost">تصدير CSV</button>
      <input type="file" id="import-history" accept="application/json" style="display:none" />
      <button id="import-history-btn" class="ghost">استيراد أرشيف</button>
    </div>
  </div>

  <div class="card">
    <h3>💵 الدخل الشهري (راتب)</h3>
    <div class="row" style="align-items:flex-end">
      <div style="flex:1 1 260px">
        <label>الراتب الشهري</label>
        <input id="salary2" type="number" placeholder="" />
      </div>
    </div>
  </div>

  <div class="card">
    <h3>➕ الدخل الإضافي</h3>
    <label>اسم الدخل</label>
    <input id="extra-name" placeholder="مثال: عمل إضافي" />
    <label>قيمة الدخل</label>
    <input id="extra-amount" type="number" />
    <button id="add-extra" class="primary" style="margin-top:10px">➕ إضافة دخل</button>
    <table class="main-table">
      <thead><tr><th>دخل</th><th class="col-paid">المبلغ</th><th>إجراء</th></tr></thead>
      <tbody id="extras-rows"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>🧾 المصروفات</h3>
    <label>اسم المصروف</label>
    <div class="row" style="gap:8px">
      <select id="name" style="flex:1 1 220px"></select>
      <input id="name-custom" placeholder="اكتب هنا لو اخترت (أخرى)" style="flex:1 1 220px" />
      <button id="save-custom-cat" class="ghost">💾 حفظ كخيار دائم</button>
      <button id="delete-cat" class="danger">🗑️ حذف الفئة المختارة</button>
    </div>
    <label>المبلغ المخطط</label><input id="planned" type="number" />
    <label>المدفوع حتى الآن</label><input id="paid" type="number" />
    <!-- FIX: no inline onclick/ontouchend -->
    <button id="add" type="button" class="primary" style="margin-top:12px">➕ إضافة بند</button>

    <table class="main-table">
      <thead><tr><th>المصروف</th><th class="col-planned">المخطط</th><th class="col-paid">المدفوع</th><th class="col-due">المتبقي</th><th>الحالة</th><th>إجراءات</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
    <div class="totals">
      <div><div class="pill">إجمالي المخطط</div><h3 id="t_planned">0</h3></div>
      <div><div class="pill">إجمالي المدفوع</div><h3 id="t_paid">0</h3></div>
      <div><div class="pill">المتبقي على البنود</div><h3 id="t_due">0</h3></div>
      <div><div class="pill">الرصيد المتوقع</div><h3 id="t_balance">0</h3></div>
    </div>
  </div>

  <div class="card">
    <h3>📈 الاستثمارات</h3>
    <p class="muted">هذه القائمة مستقلة تمامًا ولا تؤثر على المصروفات أو الأرصدة.</p>
    <div class="row">
      <div style="flex:1 1 220px"><label>نوع الاستثمار</label><input id="inv-type" placeholder="مثال: أسهم، بيتكوين، عقار" /></div>
      <div style="flex:1 1 220px"><label>الوجهة / أين ذهبت الأموال</label><input id="inv-dest" placeholder="مثال: Tesla، BTC Wallet، صندوق مؤشر" /></div>
      <div style="flex:1 1 180px"><label>المبلغ (هذا الشهر)</label><input id="inv-amount" type="number" /></div>
      <div style="flex:1 1 220px"><label>مصدر الأموال</label><input id="inv-source" placeholder="راتب، دخل إضافي، سحب من ادخار..." /></div>
    </div>
    <label>ملاحظات / تفاصيل إضافية (اختياري)</label>
    <textarea id="inv-notes" placeholder="تفاصيل مثل: التاريخ، الوسيط، رسوم..."></textarea>
    <button id="add-inv" class="primary" style="margin-top:12px">➕ إضافة استثمار</button>
    <table class="main-table">
      <thead><tr><th>النوع</th><th>الوجهة</th><th class="col-paid">المبلغ</th><th>المصدر</th><th>الشهر</th><th>تفاصيل</th><th>إجراء</th></tr></thead>
      <tbody id="inv-rows"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>📚 الأرشيف الشهري</h3>
    <div class="row" style="margin-bottom:10px">
      <div style="flex:1 1 220px"><label>اختر شهرًا</label><select id="history-select"></select></div>
      <button id="delete-month" class="danger">حذف هذا الشهر</button>
    </div>
    <div id="history-kpis" class="totals"></div>
    <div id="history-table-wrap"></div>
    <div id="history-chart-wrap"><canvas id="history-chart"></canvas></div>
    <div id="delta-chart-wrap"><canvas id="delta-chart"></canvas></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  

  <!-- Mobile enhance helper (kept, harmless with no inline handlers) -->
  <script>
  (function(){
    if (window.__mobileEnhanceV29Installed) return;
    window.__mobileEnhanceV29Installed = true;

    function ensurePanel(tr, openIfEmpty){
      var panel = tr.querySelector('td.mobile-details-panel');
      if (!panel){
        panel = document.createElement('td');
        panel.className = 'mobile-details-panel';
        var list = document.createElement('div'); list.className = 'details-list'; panel.appendChild(list);
        var ph = document.createElement('div'); ph.className = 'placeholder'; ph.textContent = 'لا توجد بنود تفصيلية'; panel.appendChild(ph);
        tr.appendChild(panel);
      }
      var list = panel.querySelector('.details-list'); var ph = panel.querySelector('.placeholder');
      if (openIfEmpty === true) panel.style.display = 'block'; ph.style.display = list.children.length > 0 ? 'none' : 'block'; return panel;
    }

    function updatePaidFromPanel(tr){
      var panel = tr.querySelector('td.mobile-details-panel'); if (!panel) return;
      var vals = panel.querySelectorAll('.detail-item input[data-role="value"]'); var sum = 0;
      vals.forEach(function(inp){ var v = parseFloat((inp.value || '').replace(/,/g,'')); if (!isNaN(v)) sum += v; });
      var paidInput = tr.querySelector('td:nth-child(3) input'); if (paidInput){ paidInput.value = sum || 0; }
      var pEl = tr.querySelector('td:nth-child(2) input'); var dEl = tr.querySelector('td:nth-child(3) input');
      var planned = parseFloat((pEl && pEl.value)||0) || 0; var paid = parseFloat((dEl && dEl.value)||0) || 0;
      var el = tr.querySelector('.mobile-status-text') || (function(){ var e=document.createElement('div'); e.className='mobile-status-text neutral'; var cell=tr.querySelector('td:nth-child(5)'); if(cell) cell.appendChild(e); return e; })();
      if (paid > planned){ var diff = (paid - planned).toFixed(2).replace(/\.00$/,''); el.className='mobile-status-text over'; el.textContent='تجاوز المخطط بـ ' + diff; }
      else if (planned > paid){ var left = (planned - paid).toFixed(2).replace(/\.00$/,''); el.className='mobile-status-text ok'; el.textContent='المتبقي ' + left; }
      else { el.className='mobile-status-text neutral'; el.textContent='مطابق للمخطط'; }
    }

    function addDetailItem(tr){
      if (tr.dataset.detailLock === '1') return; tr.dataset.detailLock = '1'; setTimeout(function(){ tr.dataset.detailLock = '0'; }, 300);
      var panel = ensurePanel(tr, true); var list = panel.querySelector('.details-list');
      var item = document.createElement('div'); item.className = 'detail-item';
      var name = document.createElement('input'); name.type = 'text'; name.placeholder = 'اسم التفصيل';
      var value = document.createElement('input'); value.type = 'number'; value.setAttribute('data-role','value'); value.placeholder = 'القيمة'; value.inputMode = 'numeric'; value.pattern = '[0-9]*';
      value.addEventListener('input', function(){ updatePaidFromPanel(tr); });
      var del = document.createElement('button'); del.type = 'button'; del.className = 'del'; del.textContent = '×';
      del.addEventListener('click', function(){ item.remove(); var panel = ensurePanel(tr, false); var list = panel.querySelector('.details-list'); panel.querySelector('.placeholder').style.display = list.children.length > 0 ? 'none' : 'block'; updatePaidFromPanel(tr); });
      item.appendChild(name); item.appendChild(value); item.appendChild(del); list.appendChild(item);
      panel.querySelector('.placeholder').style.display = 'none'; updatePaidFromPanel(tr);
    }

    function hideLegacyButtons(tr){
      var actionsCell = tr.querySelector('td:nth-child(6)'); if (!actionsCell) return;
      Array.from(actionsCell.querySelectorAll('button, .btn, a')).forEach(function(b){
        var t = (b.innerText||b.textContent||'').trim();
        if (/تفصيل|تفاصيل|detail|\+/.test(t)) { b.classList.add('is-details-btn'); b.style.display='none'; }
      });
    }

    function wireInputs(tr){
      var p = tr.querySelector('td:nth-child(2) input'); var d = tr.querySelector('td:nth-child(3) input');
      function refresh(){ updatePaidFromPanel(tr); }
      if (p) p.addEventListener('input', refresh); if (d) d.addEventListener('input', refresh); refresh();
    }

    function enhanceRow(tr){
      if (!tr || tr.getAttribute('data-mobile-enhanced') === '1') return; var tds = tr.querySelectorAll('td'); if (tds.length < 6) return;
      hideLegacyButtons(tr);
      var addCell = document.createElement('td'); addCell.className='mobile-details-input'; var addBtn=document.createElement('button'); addBtn.type='button'; addBtn.className='btn'; addBtn.textContent='تفصيل +'; addBtn.addEventListener('click', function(){ addDetailItem(tr); }); addCell.appendChild(addBtn);
      var toggleCell = document.createElement('td'); toggleCell.className='mobile-details-toggle'; var toggleBtn=document.createElement('button'); toggleBtn.type='button'; toggleBtn.className='btn'; toggleBtn.textContent='إظهار/إخفاء'; toggleBtn.addEventListener('click', function(){ var panel = ensurePanel(tr, false); panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none'; }); toggleCell.appendChild(toggleBtn);
      ensurePanel(tr, false);
      tr.appendChild(addCell); tr.appendChild(toggleCell);
      wireInputs(tr);
      tr.setAttribute('data-mobile-enhanced','1');
    }

    function enhanceAll(){ var table=document.getElementById('rows'); if(!table) return; var rows=table.querySelectorAll('tbody tr'); rows.forEach(enhanceRow); }
    function hideHeader(){ try{ var table=document.getElementById('rows'); if(!table) return; var prev=table.previousElementSibling; if (prev) prev.style.display='none'; }catch(e){} }

    function patchAddButton(){
      var btn = document.getElementById('add'); if (!btn) return;
      // Since we removed inline handlers already, just ensure single click handler exists (handled in bind())
    }

    function install(){
      if (!window.matchMedia || !window.matchMedia('(max-width: 430px)').matches) return;
      enhanceAll(); hideHeader(); patchAddButton();
      var table=document.getElementById('rows'); if (table){ var tb=table.querySelector('tbody') || table; var obs=new MutationObserver(function(){ enhanceAll(); }); obs.observe(tb, { childList:true, subtree:true }); }
      document.documentElement.style.overflowX='hidden'; document.body.style.overflowX='hidden';
    }

    if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', install, {once:true}); }
    else { install(); }
  })();
  </script>
  <script src="assets/js/state.js"></script>
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/expenses.js"></script>
  <script src="assets/js/extras.js"></script>
  <script src="assets/js/investments.js"></script>
  <script src="assets/js/archive.js"></script>
  <script src="assets/js/charts.js"></script>
\1